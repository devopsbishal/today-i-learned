# AWS VPC - The Compound Analogy

> Understanding AWS VPC through a real-world analogy of a secure compound with buildings, gates, and security guards.

---

## TL;DR

| AWS Concept | Real-World Analogy |
|-------------|-------------------|
| VPC | Large compound surrounded by fence |
| Availability Zones | Blocks within the compound |
| Subnets | Buildings inside blocks |
| Route Tables | Paths connecting buildings |
| Internet Gateway | Main gate for public entry |
| NAT Gateway | Agent handler (outbound only) |
| NACLs | Security guard at building entrance |
| Security Groups | Security guard at apartment door |
| VPC Peering | Direct tunnel between compounds |
| Transit Gateway | Central station connecting all compounds |
| Gateway Endpoint | Private road to AWS warehouse (S3/DynamoDB) |
| Interface Endpoint | Private phone line to AWS services |

---

## The Big Picture

Imagine a **large compound surrounded by a fence** from all sides. No one is allowed to enter without explicit permission. Even if you get inside, there are limited buildings you can access - not everyone can go everywhere.

This compound is your **VPC (Virtual Private Cloud)** - your own isolated network in AWS.

---

## Core Components

### VPC - The Compound

Your VPC is the entire fenced compound. It's completely isolated from the outside world and from other compounds (other AWS customers). You define the boundaries using a **CIDR block** (e.g., 10.0.0.0/16), which is like defining how many apartments your compound can have.

### Availability Zones - The Blocks

Inside this compound, we have **6 blocks** (typically 3 or more per AWS region). These are **Availability Zones (AZs)** - physically separate data centers with independent power, cooling, and networking. If one block catches fire, the others keep running.

### Subnets - The Buildings

Inside each block, we have **buildings** - these are your **subnets**. Each building has a range of apartment numbers (IP addresses). You decide:

- **Public buildings** - anyone can enter (resources accessible from internet)
- **Private buildings** - only authorized personnel (internal resources only)

### Route Tables - The Paths

The **paths** inside the compound determine how to get from one building to another, or how to reach the main gate. Every building (subnet) needs a path guide (route table) that says:

- "To reach building B, take this path"
- "To reach the outside world, go through the main gate"

### Internet Gateway - The Main Gate

To allow anyone from the outside to enter **public buildings**, we need a **main gate** - this is the **Internet Gateway (IGW)**. 

- Attached to the VPC
- Public subnets have a route pointing to it
- Enables two-way traffic: in and out

### NAT Gateway - The Agent Handler

Private buildings house **secret agents** (private EC2 instances). These agents need to go outside to gather information (download updates, call APIs), but we don't want outsiders to know they exist or come knocking.

Enter the **NAT Gateway** - the agent handler sitting in a public building:

1. Agent from private building wants to go outside
2. Agent goes to the handler in the public building
3. Handler gives the agent a **fake identity** (replaces private IP with NAT's public IP)
4. Handler notes in his **entry book**: "Agent from building X, apartment 42"
5. Agent goes outside with the fake identity
6. When agent returns with information, handler checks the book
7. Handler sends the agent back to the original building and apartment

**Why must NAT Gateway be in a public subnet?**
Because it needs access to the Internet Gateway! If it sat in a private building, it would have no connection to the outside world.

```
Private EC2 (10.0.1.50)
       â”‚
       â–¼
Route Table (Private) â”€â”€â–º "Send 0.0.0.0/0 to NAT Gateway"
       â”‚
       â–¼
NAT Gateway â”€â”€â–º Translates 10.0.1.50 â†’ 52.xx.xx.xx
       â”‚
       â–¼
Route Table (Public) â”€â”€â–º "Send 0.0.0.0/0 to Internet Gateway"
       â”‚
       â–¼
Internet Gateway â”€â”€â–º ðŸŒ Internet
```

---

## Security - The Guards

Every person within the compound, whether in public or private buildings, can potentially wander anywhere. To prevent unauthorized access, we have **two types of security guards**.

### NACLs - Building Security Guard

**Network Access Control Lists** are the guards stationed at **building entrances** (subnet level).

- Checks: "Is this person allowed to enter this building?"
- **Stateless**: Doesn't remember if someone entered. Checks both entry AND exit separately.
- If you allow someone in, you must explicitly allow them out too.
- Evaluates rules by number order (lowest first)

### Security Groups - Apartment Security Guard

**Security Groups** are the guards at **apartment doors** (resource level - EC2, RDS, etc.).

- Checks: "Is this person allowed to enter apartment 42?"
- **Stateful**: Remembers visitors. If you're allowed in, you're automatically allowed out.
- More intelligent, does deep-level checks
- Only allow rules (implicit deny everything else)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Building (Subnet)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚           NACL (Building Guard)        â”‚ â”‚
â”‚  â”‚  "Can this person enter the building?" â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚                       â”‚
â”‚                     â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Apartment (EC2)                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ Security Group (Apt Guard)    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ "Can this person enter apt?"  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Connecting Multiple VPCs

As you expand, you'll have multiple compounds in different regions. How do they communicate?

### VPC Peering - Direct Tunnels

Create a **direct tunnel** between two compounds:

```
Compound A â—„â”€â”€â”€â”€tunnelâ”€â”€â”€â”€â–º Compound B
```

**The catch**: Tunnels are **not transitive**. If A connects to B, and B connects to C, A cannot talk to C through B. You need a separate Aâ†”C tunnel.

For 3 VPCs: 3 tunnels
For 5 VPCs: 10 tunnels  
For N VPCs: N(N-1)/2 tunnels ðŸ˜±

### Transit Gateway - Central Station

Instead of mesh tunnels, build a **central station** that everyone connects to:

```
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Transit Gateway â”‚
              â”‚   (Station)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚           â”‚           â”‚
           â–¼           â–¼           â–¼
      Compound A   Compound B   Compound C
```

Now:
- Aâ†’Stationâ†’C works automatically (**transitive**)
- Adding new VPC = just one connection to the station
- Scales linearly: N VPCs = N connections

### Important: No Overlapping Addresses!

If Compound A and Compound B both have apartments numbered 10.0.1.0 - 10.0.1.255, they **cannot communicate**. The station wouldn't know which compound to send traffic to.

**Always plan your CIDR blocks to avoid overlap:**

| VPC | CIDR |
|-----|------|
| Compound A | 10.**0**.0.0/16 |
| Compound B | 10.**1**.0.0/16 |
| Compound C | 10.**2**.0.0/16 |

---

## Private Access to AWS Services

Your private buildings need to access AWS services like S3 or Secrets Manager. The standard path:

```
Private Building â†’ NAT Gateway â†’ Internet Gateway â†’ ðŸŒ â†’ AWS S3
```

Problems: Internet exposure, NAT costs, higher latency.

**Solution**: VPC Endpoints - private doors directly to AWS services.

### Gateway Endpoints - Private Road (S3 & DynamoDB)

A private road built directly to specific AWS warehouses:

```
Private EC2 â†’ Route Table â†’ Gateway Endpoint â†’ AWS S3
                               (never touches internet)
```

- **Free!** No hourly or data processing charges
- Just add a route in your route table
- Only works for **S3** and **DynamoDB**

### Interface Endpoints (PrivateLink) - Private Phone Line

For other AWS services (Secrets Manager, SQS, SNS, etc.), AWS installs a **private phone** in your building:

```
Private EC2 â†’ Interface Endpoint (ENI: 10.0.1.55) â†’ AWS Secrets Manager
                    (private IP in your subnet)
```

- Creates an **ENI (Elastic Network Interface)** with a private IP in your subnet
- Your EC2 calls that local IP, which connects privately to AWS
- Costs: ~$0.01/hour per AZ + $0.01/GB (still cheaper than NAT for most cases)

### Cost-Optimization Strategy

| Service | Frequency | Best Choice |
|---------|-----------|-------------|
| S3 | Frequent | Gateway Endpoint (free!) |
| DynamoDB | Frequent | Gateway Endpoint (free!) |
| Secrets Manager | Occasional | Interface Endpoint |
| Other AWS services | Varies | Interface Endpoint |

---

## AWS Global Backbone

One last thing: all this "private" traffic - PrivateLink, VPC Peering, Transit Gateway - travels on **AWS's own global network infrastructure**:

- Private fiber optic cables (undersea + terrestrial)
- 100+ Tbps capacity
- Never touches the public internet
- Lower latency, more secure, predictable performance

It's like AWS built their own private highway system across the world, and your traffic rides on that instead of public roads.

---

## Key Takeaways

1. **VPC is your isolated network** - design it like a secure compound
2. **Subnets are public or private** based on their route to Internet Gateway
3. **NAT Gateway** enables private resources to reach internet (outbound only)
4. **Security Groups are stateful, NACLs are stateless** - use both for defense in depth
5. **Transit Gateway > VPC Peering** when connecting many VPCs
6. **VPC Endpoints save money and improve security** - use Gateway Endpoints for S3/DynamoDB
7. **Plan your CIDRs upfront** - overlapping ranges cannot communicate
8. **AWS traffic stays on AWS backbone** - never touches public internet

---

*Written on November 30, 2025*
